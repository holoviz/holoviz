sudo: true
language: generic
os:
  - linux

env:
  global:
    - CHANS_DEV="-c conda-forge -c defaults -c pyviz/label/dev"   # this order matters because we're using strict channel priority
    - CHANS_REL="-c conda-forge -c defaults -c https://conda.anaconda.org/pyviz"  # this order matters because we're using strict channel priority
    - LABELS_DEV="--label dev"
    - LABELS_REL="--label dev --label main"
    - PYENV_VERSION=3.7
    - PYTHON_VERSION=3.6
    - PKG_TEST_PYTHON="--test-python=py36"
    - PIN="--pin-deps"
    - CHANS=$CHANS_DEV
    - OPTIONS="-o graph -o indirect"

stages:
  - test

jobs:
  include:
    - &default
      stage: test
      env: DESC="Deploy dev website to pyviz-dev.github.io/holoviz" OPTIONS="-o doc -o indirect -o graph" CHANS=$CHANS_REL
      os: linux
      install:
        - pip install pyctdev && doit miniconda_install && pip uninstall -y doit pyctdev
        - export PATH="$HOME/miniconda/bin:$PATH" && hash -r
        - conda config --set always_yes True
        - conda install -c pyviz/label/dev "pyctdev>=0.5" && doit ecosystem_setup
        - conda config --set path_conflict warn
        - conda config --set channel_priority strict  # this makes the conda solver **way** faster
      before_script:
        - doit env_create $CHANS --name=holoviz --python=$PYTHON_VERSION
        - source activate holoviz
        - doit develop_install $CHANS $OPTIONS
        - pip install msgpack nbsmoke # workaround for unfortunate combination of msgpack vs msgpack-python + no conda develop command + pkg_resources checking what's installed for entrypoints + msgpack/rise conflict via conda; need to investigate
        - doit env_capture
      script:
        - bokeh sampledata
        - holoviz fetch-data --path=examples
        - nbsite generate-rst --org holoviz --project-name holoviz --offset 1
        - nbsite build --what=html --output=builtdocs

notifications:
  email: false
